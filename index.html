<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rizsim Studio's App.js Generator</title>
<meta name="author" content="Rizsim Studios">
<link rel="icon" href="favicon.png" type="image/x-icon">
<meta property="og:image" content="favicon.png">
<meta property="og:type" content="website">
<meta property="og:title" content="Rizsim's App JS Generator">
<meta property="og:description" content="A small app js generator I made for Incredibox modding.">
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
h1 {
 font-size: 24px;
user-select: none; 
-webkit-user-select: none; 
-moz-user-select: none; 
 -ms-user-select: none; 
 }
 
 h3, #importFile {
 user-select: none; 
-webkit-user-select: none; 
-moz-user-select: none; 
 -ms-user-select: none;
 -webkit-user-drag: none;
-khtml-user-drag: none;
-moz-user-drag: none;
-o-user-drag: none;
user-drag: none;
 }

br {
user-select: none; 
-webkit-user-select: none; 
-moz-user-select: none; 
 -ms-user-select: none;
 -webkit-user-drag: none;
-khtml-user-drag: none;
-moz-user-drag: none;
-o-user-drag: none;
user-drag: none;
}

.hidden-by-default {
  display: none;
}

label { 
display: block; 
margin-top: 10px; 
font-weight: bold; 
user-select: none; 
-webkit-user-select: none; 
-moz-user-select: none; 
 -ms-user-select: none;
 -webkit-user-drag: none;
-khtml-user-drag: none;
-moz-user-drag: none;
-o-user-drag: none;
user-drag: none;
}

input[type="text"], input[type="number"], input[type="color"], select { 
padding: 6px; 
margin-bottom: 10px; 
user-select: none; 
-webkit-user-select: none; 
-moz-user-select: none; 
 -ms-user-select: none;
}

input[type="checkbox"] { margin-right: 5px; }

button { 
margin-top: 10px; 
padding: 10px; 
background: #4CAF50; 
color: #fff; 
border: none; 
cursor: pointer; 
user-select: none; 
-webkit-user-select: none; 
-moz-user-select: none; 
 -ms-user-select: none;
}

#preset {
user-select: none; 
-webkit-user-select: none; 
-moz-user-select: none; 
 -ms-user-select: none;
}

button:hover { background: #45a049; }
.anime-array, .bonus-array { border: 1px solid #ccc; padding: 10px; margin-top: 10px; max-height: 300px; overflow-y: auto; }

.anime-row, .bonus-row { 
display: flex; 
align-items: center; 
margin-bottom: 5px; 
gap: 5px; 
flex-wrap: wrap; 
 -webkit-user-drag: none;
-khtml-user-drag: none;
-moz-user-drag: none;
-o-user-drag: none;
user-drag: none;
}

.anime-row input[type="text"], .bonus-row input[type="text"] { width: 100px; }
.anime-row input[type="color"] { width: 60px; height: 30px; padding: 0; border: none; }
.color-preview { width: 30px; height: 30px; border: 1px solid #000; display: inline-block; }

.loop-info { 
font-size: 12px; 
font-weight: bold; 
user-select: none; 
-webkit-user-select: none; 
-moz-user-select: none; 
 -ms-user-select: none;
  -webkit-user-drag: none;
-khtml-user-drag: none;
-moz-user-drag: none;
-o-user-drag: none;
user-drag: none;
}
</style>
</head>
<body>

<h1>Rizsim Studio's App.js Generator</h1>

<label for="preset">Select Preset:</label>
<select id="preset">
  <option value="" disabled selected hidden>-- Choose Preset --</option>
  <option value="v9">v9 Template</option>
  <option value="modbox">Modbox</option>
</select>

<br>

<div>
<label>Import a v8 app.js, RMB apps.js or Modbox app.json:</label>
<input type="file" id="importFile" accept=".js,.json">
</div>

<br>

<label id="versionLabel" class="hidden-by-default" for="versionSelect">
  Select Version:
</label>
<select id="versionSelect" class="hidden-by-default" disabled>
  <option value="">-- Select --</option>
</select>

<br>

<form id="appForm">

<!-- General Fields -->
<div class="hidden-by-default" id="generalFields">
  <div><label>Name:</label><input type="text" id="name" placeholder="Template"></div>
  <div><label>Version:</label><input type="text" id="version" placeholder="1"></div>
  <div><label>Date:</label><input type="text" id="date" placeholder="2026"></div>
  <div><label>Folder:</label><input type="text" id="folder" placeholder="asset-v1/"></div>
  <div><label>Background:</label><input type="text" id="background" placeholder="game-bck@2x.jpg"></div>
  <div><label>Polo Sprite:</label><input type="text" id="poloSprite" placeholder="polo-sprite.png"></div>
  <div><label>Loop Time:</label><input type="number" id="looptime" placeholder="3429"></div>
  <div><label>BPM:</label><input type="number" id="bpm" placeholder="90"></div>
  <div><label>Total Frame:</label><input type="number" id="totalframe" placeholder="164"></div>
  <div><label>Number of Polo:</label><input type="number" id="nbpolo" placeholder="7"></div>
  <div><label>Max Record Loop:</label><input type="number" id="maxrecloop" placeholder="24"></div>
  
  <br>

<div><label><input type="checkbox" id="bonusloopA" checked> Bonus Loop A</label></div>
<div><label><input type="checkbox" id="bonusendloopA"> Bonus End Loop A</label></div>
</div>

<br>

<!-- Colors -->
<div class="hidden-by-default" id="colorsSection">
<label>Colors:</label>
<div><input type="color" id="colBck" value="#0F0F0F"><input type="text" id="colBckHex"  placeholder="#0F0F0F" style="width:80px;"></div>
<div><input type="color" id="col0" value="#919191"><input type="text" id="col0Hex"  placeholder="#919191"  style="width:80px;"></div>
<div><input type="color" id="col1" value="#5f5f5f"><input type="text" id="col1Hex"  placeholder="#5F5F5F"  style="width:80px;"></div>
<div><input type="color" id="col2" value="#4b4b4b"><input type="text" id="col2Hex"  placeholder="#4B4B4B"  style="width:80px;"></div>
<div><input type="color" id="col3" value="#373737"><input type="text" id="col3Hex"  placeholder="#373737"  style="width:80px;"></div>
<div><input type="color" id="col4" value="#232323"><input type="text" id="col4Hex"  placeholder="#232323"  style="width:80px;"></div>
</div>

<br>

<!-- Custom Section -->
<div class="hidden-by-default" id="customSection">
<label>Custom:</label>
  <label for="snowing">
    <input type="checkbox" id="snowing"> Snowing
  </label>
</div>

<br>

<!-- Anime Array -->
<div class="hidden-by-default" id="animeSection">
<label>Anime Array (Polos):</label>
<div class="anime-array" id="animeArray"></div>
<button type="button" id="addAnime">+ Add Polo</button>
</div>

<br>

<!-- Bonus Array -->
<div class="hidden-by-default" id="bonusSection">
<label>Bonus Array:</label>
<div class="bonus-array" id="bonusArray"></div>
<button type="button" id="addBonus">+ Add Bonus</button>
</div>

<br>

<!-- Credits Section -->
<div class="hidden-by-default" id="creditsSection">
  <h3>Credits</h3>

  <label for="crewname">Crew Name:</label>
  <input type="text" id="crewname" placeholder="ARP Modders">

  <div>
    <label for="processToggle">
      <input type="checkbox" id="processToggle" checked> Process
    </label>
    <input type="text" id="process" placeholder="Allan, Romain, Paul">
  </div>

  <div>
    <label for="musicToggle">
      <input type="checkbox" id="musicToggle" checked> Music
    </label>
    <input type="text" id="music" placeholder="Paul">
  </div>

  <div>
    <label for="designToggle">
      <input type="checkbox" id="designToggle" checked> Design
    </label>
    <input type="text" id="design" placeholder="Romain">
  </div>

  <div>
    <label for="animationToggle">
      <input type="checkbox" id="animationToggle" checked> Animation
    </label>
    <input type="text" id="animation" placeholder="Allan">
  </div>

  <div>
    <label for="thanksToggle">
      <input type="checkbox" id="thanksToggle" checked> Thanks
    </label>
    <input type="text" id="thanks" placeholder="To the best community ever">
  </div>
</div>


<br>

<div class="hidden-by-default" id="generateBtnContainer">
<button type="button" id="generate">Generate app.js</button>
</div>

</form>

<script>
// Preset handling
const presetSelect = document.getElementById('preset');

// Listen for preset changes and update the button label
presetSelect.addEventListener('change', () => {
document.getElementById('generalFields').style.display = 'block';
  document.getElementById('colorsSection').style.display = 'block';
    document.getElementById('animeSection').style.display = 'block';
  document.getElementById('bonusSection').style.display = 'block';
    document.getElementById('generateBtnContainer').style.display = 'block';


  toggleFieldsByPreset(presetSelect.value);
  updateGenerateButtonLabel(presetSelect.value);
  updateDateFieldByPreset(presetSelect.value);
  updateVersionControlsVisibility(presetSelect.value);
});

// Function to update the Generate button label
function updateGenerateButtonLabel(preset) {
  const generateButton = document.getElementById('generate');
  if (preset === 'modbox') {
    generateButton.textContent = 'Generate app.json';  // Change the button text to 'Generate app.json' when Modbox is selected
  } else {
    generateButton.textContent = 'Generate apps.js';   // Default to 'Generate app.js' otherwise
  }
}

document.getElementById('processToggle').addEventListener('change', (e) => {
  document.getElementById('process').disabled = !e.target.checked;
});

document.getElementById('musicToggle').addEventListener('change', (e) => {
  document.getElementById('music').disabled = !e.target.checked;
});

document.getElementById('designToggle').addEventListener('change', (e) => {
  document.getElementById('design').disabled = !e.target.checked;
});

document.getElementById('animationToggle').addEventListener('change', (e) => {
  document.getElementById('animation').disabled = !e.target.checked;
});

document.getElementById('thanksToggle').addEventListener('change', (e) => {
  document.getElementById('thanks').disabled = !e.target.checked;
});


// Initialize button label when the page loads (in case a preset is already selected)
updateGenerateButtonLabel(presetSelect.value);

function toggleFieldsByPreset(preset) {
  const isModbox = preset === 'modbox';
  const isV9 = preset === 'v9';

  // ---- GENERAL FIELD TOGGLES ----
  const fieldsToToggle = ['version','folder','background','poloSprite','nbpolo','maxrecloop'];
  fieldsToToggle.forEach(id => {
    const el = document.getElementById(id).parentElement;
    el.style.display = isModbox ? 'none' : 'block';
  });

  // ---- MODBOX-ONLY SECTIONS ----
  document.getElementById('creditsSection').style.display = isModbox ? 'block' : 'none';
  document.getElementById('customSection').style.display  = isModbox ? 'block' : 'none';

  // ---- BONUS ICONS ----
  document.querySelectorAll('.icon-wrap').forEach(wrap => {
    wrap.style.display = isModbox ? 'none' : 'inline-flex';
  });
}

// Color preview
["colBck","col0","col1","col2","col3","col4"].forEach(c=>{
  const input = document.getElementById(c);
  const hex = document.getElementById(c+'Hex');
  input.addEventListener('input',()=>hex.value=input.value.toUpperCase());
});

// Anime Array
const animeArrayDiv = document.getElementById('animeArray');

function getNextPoloNumber() {
  const rows = animeArrayDiv.querySelectorAll('input[type="text"]');
  
  // Collect all numbers from existing polos (value or placeholder)
  const numbers = Array.from(rows)
    .map(r => {
      const match = (r.value || r.placeholder).match(/^(\d+)_polo$/);
      return match ? parseInt(match[1]) : null;
    })
    .filter(n => n !== null);

  // Next number is max + 1
  return numbers.length ? Math.max(...numbers) + 1 : 1;
}



function createAnimeRow(name,color="#7D7D7D",uniq=true, isImport=false){
  if(!name) name=`${getNextPoloNumber()}_polo`;
  const row = document.createElement('div');
  row.className = 'anime-row';

  const nameInput = document.createElement('input');
  nameInput.type = 'text';
  
  nameInput.placeholder = `${getNextPoloNumber()}_polo`;

  // PLACEHOLDER logic
  if (name) {
    nameInput.placeholder = "temp_polo";
  } else {
    nameInput.placeholder = `${getNextPoloNumber()}_polo`;
  }

  // If this row comes from an import, set value
  // Otherwise (startup), leave value empty and use placeholder
  if (isImport) {
    nameInput.value = name;
  } else {
    nameInput.value = '';
    nameInput.placeholder = name;
  }

  const colorInput = document.createElement('input'); 
  colorInput.type= 'color'; 
  
  const hexInput = document.createElement('input'); 
  hexInput.type = 'text'; 
  hexInput.readOnly = false; 
  hexInput.style.width = '60px'; 
  
  const preview = document.createElement('div'); 
  preview.className ='color-preview'; 
  
  if (isImport) {
    colorInput.value = color;
    hexInput.value = color.toUpperCase();
	hexInput.placeholder = "#7D7D7D"; // default startup color
    preview.style.backgroundColor = color;
  } else {
    colorInput.value = "#7D7D7D"; // default startup color
    hexInput.placeholder = "#7D7D7D";
    preview.style.backgroundColor = "#7D7D7D";
  }
  
  const uniqInput=document.createElement('input'); uniqInput.type='checkbox'; uniqInput.checked=uniq;
  const loopInfo=document.createElement('span'); loopInfo.className='loop-info'; loopInfo.textContent=uniq?'1 loop':'2 loops';
  uniqInput.addEventListener('change',()=>loopInfo.textContent=uniqInput.checked?'1 loop':'2 loops');
  const removeBtn=document.createElement('button'); removeBtn.type='button'; removeBtn.textContent='-';
  removeBtn.addEventListener('click',()=>animeArrayDiv.removeChild(row));
  [nameInput,colorInput,hexInput,preview,uniqInput,loopInfo,removeBtn].forEach(el=>row.appendChild(el));
  colorInput.addEventListener('input',()=>{hexInput.value=colorInput.value.toUpperCase(); preview.style.backgroundColor=colorInput.value;});
  animeArrayDiv.appendChild(row);
}

for (let i = 0; i < 20; i++) {
  createAnimeRow(`${i + 1}_polo`);
}

document.getElementById('addAnime').addEventListener('click',()=>createAnimeRow());

// Bonus Array
const bonusArrayDiv = document.getElementById('bonusArray');
function createBonusRow(bonus={}){
  const row = document.createElement('div'); row.className='bonus-row';

  // Name, src, code, sound
  const fields = [
    {name:'name', placeholder:'Blank', value:''},
    {name:'src', placeholder:'v1-b1-blank-hb', value:''},
    {name:'code', placeholder:'1,2,3,4,5', value:''},
    {name:'sound', placeholder:'bonus-blank', value:''}
  ];
  fields.forEach(f=>{
    const input=document.createElement('input');
    input.type='text'; input.name=f.name; input.placeholder=f.placeholder;
    input.value = bonus[f.name] || f.value;
    row.appendChild(input);
  });

// Icon (hidden for modbox)
const iconWrap = document.createElement('div');
iconWrap.className = 'icon-wrap';

const iconInput = document.createElement('input');
iconInput.type = 'text';
iconInput.name = 'icon';
iconInput.placeholder = 'Icon';
iconInput.value = bonus.icon || '';
iconInput.style.width = '60px';

const iconCheck = document.createElement('input');
iconCheck.type = 'checkbox';
iconCheck.checked = !!bonus.icon;

iconWrap.appendChild(iconInput);
iconWrap.appendChild(iconCheck);
row.appendChild(iconWrap);

// Hide icon if modbox preset is active
if (document.getElementById('preset').value === 'modbox') {
  iconWrap.style.display = 'none';
}


  // Aspire
  const aspireInput = document.createElement('input'); aspireInput.type='text'; aspireInput.name='aspire'; aspireInput.placeholder='aspire-blank'; aspireInput.value = bonus.aspire || bonus.predrop || ''; aspireInput.style.width='60px';
  const aspireCheck = document.createElement('input'); aspireCheck.type='checkbox'; aspireCheck.checked = !!aspireInput.value;
  row.appendChild(aspireInput); row.appendChild(aspireCheck);

  // Loop
  const loopInput = document.createElement('input'); loopInput.type='number'; loopInput.name='loop'; loopInput.value=bonus.loop||1; loopInput.style.width='50px';
  row.appendChild(loopInput);

  // Remove
  const removeBtn = document.createElement('button'); removeBtn.type='button'; removeBtn.textContent='-';
  removeBtn.addEventListener('click',()=>bonusArrayDiv.removeChild(row));
  row.appendChild(removeBtn);

  bonusArrayDiv.appendChild(row);
}
document.getElementById('addBonus').addEventListener('click',()=>createBonusRow());


function applyJsonToUI(json) {
  const isV9 = json.hasOwnProperty('folder') && json.hasOwnProperty('poloSprite');
  const isModbox = json.hasOwnProperty('colors') && !json.hasOwnProperty('folder');

  // Preset
  if (isV9) {
    document.getElementById('preset').value = 'v9';
    toggleFieldsByPreset('v9');
    updateGenerateButtonLabel('v9');
  }

  if (isModbox) {
    document.getElementById('preset').value = 'modbox';
    toggleFieldsByPreset('modbox');
    updateGenerateButtonLabel('modbox');
  }
  
  // ---- CUSTOM (Modbox) ----
const snowingCheckbox = document.getElementById('snowing');

if (json.custom && typeof json.custom.snowing === 'boolean') {
  snowingCheckbox.checked = json.custom.snowing;
} else {
  // default if not present
  snowingCheckbox.checked = false;
}

  // General fields
  document.getElementById('name').value = json.name || 'Template';
  document.getElementById('version').value = json.version || '1';
  document.getElementById('date').value = json.date || '2025';
  document.getElementById('folder').value = json.folder || 'asset-v1/';
  document.getElementById('background').value = json.background || 'game-bck@2x.jpg';
  document.getElementById('poloSprite').value = json.poloSprite || 'polo-sprite.png';
  document.getElementById('looptime').value = json.looptime || '3429';
  document.getElementById('bpm').value = json.bpm || '90';
  document.getElementById('totalframe').value = json.totalframe || '164';
  document.getElementById('nbpolo').value = json.nbpolo || '7';
  document.getElementById('maxrecloop').value = json.maxrecloop || '24';

  document.getElementById('bonusloopA').checked = !!json.bonusloopA || true;
  document.getElementById('bonusendloopA').checked = !!json.bonusendloopA || false;

  // ---- COLORS ----
  if (isModbox && Array.isArray(json.colors)) {
    const map = ['col0','col1','col2','col3','col4','colBck'];
    map.forEach((id,i)=>{
      if(json.colors[i]){
        document.getElementById(id).value = json.colors[i];
        document.getElementById(id+'Hex').value = json.colors[i].toUpperCase(); // use value, not placeholder
      }
    });
  } else {
    const keys = ['colBck','col0','col1','col2','col3','col4'];
    keys.forEach(id=>{
      if(json[id]){
        document.getElementById(id).value = json[id];
        document.getElementById(id+'Hex').value = json[id].toUpperCase();
      }
    });
  }

  // ---- ANIME ARRAY ----
  animeArrayDiv.innerHTML = '';
  (json.animearray || []).forEach(a => {
    let color = a.color || '#7D7D7D';
    if (!color.startsWith('#')) color = '#' + color;

    // Set value directly so it appears in input
    createAnimeRow(a.name, color, a.uniqsnd, true); // <-- pass true for isImport
  });
  if (!json.animearray?.length) createAnimeRow();

  // ---- BONUS ARRAY ----
  bonusArrayDiv.innerHTML = '';
  (json.bonusarray || []).forEach(b=>{
    const fixed = {...b};
    if(isModbox){
      fixed.name = b.title || '';
      fixed.aspire = b.predrop || '';
      if(Array.isArray(b.code)) fixed.code = b.code.join(',');
      fixed.src = b.name || '';
    }
    createBonusRow(fixed);
  });

  // ---- CREDITS (Modbox only) ----
  if(isModbox && json.credit){
    const credit=json.credit;
    document.getElementById('crewname').value = credit.crewname || '';
    
    const map=(k,t,i,arr=true)=>{
      const toggle=document.getElementById(t);
      const input=document.getElementById(i);
      if(credit[k]!==undefined){
        toggle.checked=true;
        input.disabled=false;
        input.value=arr?credit[k].join(', '):credit[k];
      } else {
        toggle.checked=false;
        input.disabled=true;
        input.value='';
      }
    };

    map('process','processToggle','process');
    map('music','musicToggle','music');
    map('design','designToggle','design');
    map('animation','animationToggle','animation');
    map('thanks','thanksToggle','thanks',false);
  }
}

let versionsCache = {};  // stores all imported versions
let currentVersion = 'v1'; // active version

// Converter function for v8 → v9
function convertV8toV9(v8App) {
  // Normalize nbloopbonus
  let bonusLoops = 1;
  if (Array.isArray(v8App.nbloopbonus)) {
    // sum or pick first? depends on your logic — here we just store as array in v9 format
    bonusLoops = v8App.nbloopbonus.slice();
  } else if (typeof v8App.nbloopbonus === "number") {
    bonusLoops = v8App.nbloopbonus;
  }

  return {
    name: v8App.name || "Template",
    version: v8App.version || "1",
    folder: v8App.folder || "asset-v1/",
    looptime: v8App.looptime || "3429",
    bpm: v8App.bpm || "90",
    totalframe: v8App.totalframe || "164",
    nbpolo: v8App.nbpolo || "7",
    maxrecloop: "24",
    bonusloopA: !!v8App.bonusloopA || true,
    bonusendloopA: !!v8App.bonusendloopA || false,
    poloSprite: v8App.spritepolo || "polo-sprite.png",
    background: "game-bck@2x.jpg",
	
	colBck: v8App.colBck || "#0F0F0F",
    col0: v8App.col0 || "#919191",
    col1: v8App.col1 || "#5F5F5F",
    col2: v8App.col2 || "#4B4B4B",
    col3: v8App.col3 || "#373737",
    col4: v8App.col4 || "#232323",
	
	bonusLoops: bonusLoops,
	
    animearray: v8App.animearray.map(a => ({
      name: a.name,
      color: a.color.startsWith('#') ? a.color : '#' + a.color,
      uniqsnd: !!a.uniqsnd
    })),
    bonusarray: v8App.bonusarray.map(b => ({
      name: b.name,
      src: b.src,
      code: b.code.split(',').map(n => Number(n.trim())),
      sound: b.sound,
      aspire: b.aspire,
      loop: Array.isArray(bonusLoops) ? bonusLoops[0] || 1 : bonusLoops
    }))
  };
}

// Import app.js / app.json functionality
const importFileInput = document.getElementById('importFile');
importFileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (ev) => {
    const data = ev.target.result;

    try {
      let json;
      const versionDropdown = document.getElementById('versionSelect');

      if (file.name.endsWith('.js')) {

        // ----- v8 detection -----
        if (data.includes('var app = new')) {
          // Evaluate v8 file in sandbox
          const sandbox = {};
          new Function('sandbox', data + '; sandbox.app = app;')(sandbox);

          // Convert v8 → v9
          json = convertV8toV9(sandbox.app);

          // Hide version dropdown (no versions in v8)
          versionDropdown.style.display = 'none';
          versionDropdown.disabled = true;
		  
		  updateVersionControlsVisibility('v8');

document.getElementById('generalFields').style.display = 'block';
document.getElementById('colorsSection').style.display = 'block';
document.getElementById('animeSection').style.display = 'block';
document.getElementById('bonusSection').style.display = 'block';
document.getElementById('customSection').style.display = 'none';
document.getElementById('creditsSection').style.display = 'none';
document.getElementById('generateBtnContainer').style.display = 'block';

        } else {
          // ----- already v9 -----
          const sandbox = { versions: {} };
          new Function('versions', data)(sandbox.versions);

const versionKeys = Object.keys(sandbox.versions);

if (!versionKeys.length) {
  throw new Error('No versions found in app.js');
}

// Prefer v1, otherwise fall back to first version (e.g. v21)
currentVersion = versionKeys.includes('v1')
  ? 'v1'
  : versionKeys[0];

versionsCache = sandbox.versions;
json = versionsCache[currentVersion];

          // Populate the version dropdown
          versionDropdown.innerHTML = '';
          Object.keys(versionsCache).forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            versionDropdown.appendChild(opt);
          });

          versionDropdown.value = currentVersion;
          versionDropdown.disabled = false;
          versionDropdown.style.display = 'inline-block';

          // Update currentVersion and UI when dropdown changes
          versionDropdown.onchange = () => {
            currentVersion = versionDropdown.value;
            applyJsonToUI(versionsCache[currentVersion]);
          };
		  
		  updateVersionControlsVisibility('v9');
		  
		  document.getElementById('generalFields').style.display = 'block';
document.getElementById('colorsSection').style.display = 'block';
document.getElementById('animeSection').style.display = 'block';
document.getElementById('bonusSection').style.display = 'block';
document.getElementById('customSection').style.display = 'none';
document.getElementById('creditsSection').style.display = 'none';
document.getElementById('generateBtnContainer').style.display = 'block';
        }

      } else {
        // JSON file (Modbox)
        json = JSON.parse(data);
        versionDropdown.style.display = 'none';
        versionDropdown.disabled = true;
		
		updateVersionControlsVisibility('modbox');
		
		document.getElementById('generalFields').style.display = 'block';
document.getElementById('colorsSection').style.display = 'block';
document.getElementById('animeSection').style.display = 'block';
document.getElementById('bonusSection').style.display = 'block';
document.getElementById('customSection').style.display = 'block';
document.getElementById('creditsSection').style.display = 'block';
document.getElementById('generateBtnContainer').style.display = 'block';	
      }

      // Apply to UI
      applyJsonToUI(json);
      alert('Import successful!');

    } catch (err) {
      console.error(err);
      alert('Failed to import file: ' + err.message);
    }
  };

  reader.readAsText(file);
});


function parseList(value) {
  return value
    .split(',')
    .map(v => v.trim())
    .filter(Boolean);
}

document.getElementById('generate').addEventListener('click', () => {
const animearray = Array.from(
  document.querySelectorAll('.anime-row')
).map(r => ({
  name: r.children[0].value || r.children[0].placeholder, // <-- fallback to placeholder
  color: r.children[1].value,
  uniqsnd: r.children[4].checked
}));

const isModbox = document.getElementById('preset').value === 'modbox';

let bonusarray = Array.from(
  document.querySelectorAll('.bonus-row')
).map(r => {
  const nameVal = r.querySelector('input[name="name"]').value;
  const srcVal = r.querySelector('input[name="src"]').value;
  const codeVal = r.querySelector('input[name="code"]').value;
  const soundVal = r.querySelector('input[name="sound"]').value;
  const aspireVal = r.querySelector('input[name="aspire"]').value;

  if (isModbox) {
    // Modbox-specific format
    return {
      title: nameVal || "Blank",
      name: srcVal || "b1-blank",
	  code: codeVal || "1,2,3,4,5",
      sound: soundVal || "bonus1_blank",
      predrop: aspireVal || "predrop_blank",
      loop: Number(r.querySelector('input[name="loop"]').value) || 1
    };
  } else {
    // v9 / old apps.js format (unchanged)
    return {
      name: nameVal || "Blank",
      src: srcVal || "v1-b1-blank",
      code: codeVal || "1,2,3,4,5",
      sound: soundVal || "bonus-blank",
      aspire: aspireVal || "aspire-blank",
      loop: Number(r.querySelector('input[name="loop"]').value) || 1
    };
  }
});

  let obj;
  
  const defaultCredit = {
  crewname: "ARP Modders",
  process: ["Allan", "Romain", "Paul"],
  music: ["Paul"],
  design: ["Romain"],
  animation: ["Allan"],
  thanks: "To the best community ever"
  };

  if (isModbox) {
    obj = {
      name: document.getElementById('name').value || "Modbox",
      date: document.getElementById('date').value || "01-21-2025",
      looptime: Number(document.getElementById('looptime').value) || 8000,
      bpm: Number(document.getElementById('bpm').value) || 120,
      totalframe: Number(document.getElementById('totalframe').value) || 384,
      bonusloopA: document.getElementById('bonusloopA').checked || true,
      bonusendloopA: document.getElementById('bonusendloopA').checked || false,

      colors: [
        document.getElementById('col0').value || '#D8A365',
        document.getElementById('col1').value || '#BA7B3D',
        document.getElementById('col2').value || '#A16224',
        document.getElementById('col3').value || '#6A3501',
        document.getElementById('col4').value || '#422101',
        document.getElementById('colBck').value || '#201200'
      ],

    animearray: animearray,	

	custom: {
    snowing: document.getElementById('snowing').checked
	},  

credit: {
  crewname: document.getElementById('crewname').value || defaultCredit.crewname, 
  process: (document.getElementById('processToggle').checked && document.getElementById('process').value) ? parseList(document.getElementById('process').value) : defaultCredit.process, 
  music: (document.getElementById('musicToggle').checked && document.getElementById('music').value) ? parseList(document.getElementById('music').value) : defaultCredit.music,
  design: (document.getElementById('designToggle').checked && document.getElementById('design').value)  ? parseList(document.getElementById('design').value) : defaultCredit.design,
  animation: (document.getElementById('animationToggle').checked && document.getElementById('animation').value)  ? parseList(document.getElementById('animation').value) : defaultCredit.animation,
  thanks: document.getElementById('thanksToggle').checked ? (document.getElementById('thanks').value.trim() || "To the best community ever") : "To the best community ever"
}
    };

    if (bonusarray.length) {
      obj.bonusarray = bonusarray;
    }	

    /* ---- CUSTOM STRINGIFY ---- */

let creditSection = `"credit": {\n`;

// crewname is always included
creditSection += `    "crewname": "${obj.credit.crewname}"`;

// helper function for arrays/strings
const addLine = (key, value) => {
  if (!value) return;
  creditSection += `,\n    "${key}": ${
    Array.isArray(value)
      ? `[${value.map(v => `"${v}"`).join(', ')}]`
      : `"${value}"`
  }`;
};

// only include if toggles checked
if (document.getElementById('processToggle').checked)
  addLine('process', obj.credit.process);
if (document.getElementById('musicToggle').checked)
  addLine('music', obj.credit.music);
if (document.getElementById('designToggle').checked)
  addLine('design', obj.credit.design);
if (document.getElementById('animationToggle').checked)
  addLine('animation', obj.credit.animation);
if (document.getElementById('thanksToggle').checked)
  addLine('thanks', obj.credit.thanks);

creditSection += `\n  }`; // close credit with 4-space indentation




    // Assuming obj.colors is an array of color values
    const colorsArray = obj.colors;  // This is your colors array

    // Format the colors array as a string
    const formattedColors = `"colors":[${colorsArray.map(color => `"${color}"`).join(", ")}]`;

    // Destructure obj to separate the colors and credit properties
    const { colors, credit, ...rest } = obj;

    // Stringify the rest of the object with proper formatting
    let json = JSON.stringify(rest, null, 2);

    // Insert the formatted colors in the correct place before `bonusendloopA`
    json = json.replace(
      /("bonusendloopA":\s*(true|false),?)/,
      `$1\n\n  ${formattedColors},`
    );

    // Ensure the `animearray` and `bonusarray` are properly spaced and ordered
    json = json.replace(
      /\n\s*"animearray":/,
      `\n\n  "animearray":`
    );

    json = json.replace(
      /\n\s*"bonusarray":/,
      `\n\n  "bonusarray":`
    );

    json = json.replace(
      /\n\s*"custom":/,
      `\n\n  "custom":`
    );



if (bonusarray.length) {
  // Insert after bonusarray
  json = json.replace(
    /(\n\s*"bonusarray":\s*\[.*?\n\s*\])/s,
    (match) => `${match},\n\n  ${creditSection}`
  );
} else {
  json = json.replace(
    /\n\s*\}$/,
    `,\n\n  ${creditSection}\n}`
  );
}

// convert all "code":"1,2,3,4,5" to "code":[1,2,3,4,5]
json = json.replace(/"code":\s*"([\d,\s]+)"/g, (_, numbers) => {
  const arr = numbers.split(',').map(n => Number(n.trim())).filter(n => !isNaN(n));
  return `"code": [${arr.join(',')}]`;
});

try {
  JSON.parse(json);
} catch (e) {
  console.error("INVALID JSON OUTPUT:", json);
  alert("Generator produced invalid JSON. Check console.");
  return;
}

    // Trigger the download of the final JSON string
    download(json, 'app.json');
  } else {
// Update the current version in cache
versionsCache[currentVersion] = {
  name: document.getElementById('name').value || "Template",
  version: document.getElementById('version').value || "1",
  folder: document.getElementById('folder').value || "asset-v1/",
  background: document.getElementById('background').value || "game-bck@2x.jpg",
  poloSprite: document.getElementById('poloSprite').value || "polo-sprite.png",
  looptime: Number(document.getElementById('looptime').value) || 3429,
  bpm: Number(document.getElementById('bpm').value) || 90,
  totalframe: Number(document.getElementById('totalframe').value) || 164,
  nbpolo: Number(document.getElementById('nbpolo').value) || 7,
  maxrecloop: Number(document.getElementById('maxrecloop').value) || 24,
  bonusloopA: document.getElementById('bonusloopA').checked,
  bonusendloopA: document.getElementById('bonusendloopA').checked,
  colBck: document.getElementById('colBck').value,
  col0: document.getElementById('col0').value,
  col1: document.getElementById('col1').value,
  col2: document.getElementById('col2').value,
  col3: document.getElementById('col3').value,
  col4: document.getElementById('col4').value,
  animearray,
  bonusarray
};

// Generate apps.js containing all versions
let finalText = '';
Object.keys(versionsCache).forEach(v => {
  let versionObj = versionsCache[v];

  // 1. Stringify with 2-space indent
  let jsonStr = JSON.stringify(versionObj, null, 2);

  // 2. Add spacing before arrays (animearray, bonusarray)
  jsonStr = jsonStr.replace(
    /"animearray": \[/,
    '\n  "animearray": ['
  );

  jsonStr = jsonStr.replace(
    /"bonusarray": \[/,
    '\n  "bonusarray": ['
  );

  // 3. Wrap in JS assignment
  finalText += `versions.${v} = ${jsonStr};\n\n`;
});


download(finalText, 'apps.js');
  }

  function download(text, filename) {
    const blob = new Blob([text], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }
});

function updateDateFieldByPreset(preset) {
  const dateInput = document.getElementById('date');
  if (!dateInput) return;

  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const day = now.getDate();

  // Do NOT overwrite an imported or user-entered value
  if (dateInput.value.trim()) return;

  if (preset === 'modbox') {
    dateInput.placeholder = `${month}-${day}-${year}`;
  } else {
    dateInput.placeholder = `${year}`;
  }
}

// Duplicate Version Button (always visible)
const versionDropdown = document.getElementById('versionSelect');

const duplicateBtn = document.createElement('button');
duplicateBtn.id = 'duplicateVersionBtn'; // add an ID
duplicateBtn.style.display = 'none';
duplicateBtn.textContent = 'Duplicate Version';
duplicateBtn.style.marginLeft = '10px'; // optional, spacing
duplicateBtn.addEventListener('click', () => {
  if (!currentVersion || !versionsCache[currentVersion]) return alert('No version selected!');
  
  const newVersion = prompt("New version name:");
  if (!newVersion) return;

  // Deep copy the current version
  versionsCache[newVersion] = JSON.parse(JSON.stringify(versionsCache[currentVersion]));

  // Add to dropdown
  const opt = document.createElement('option');
  opt.value = newVersion;
  opt.textContent = newVersion;
  versionDropdown.appendChild(opt);

  // Switch to new version
  versionDropdown.value = newVersion;
  currentVersion = newVersion;
  applyJsonToUI(versionsCache[currentVersion]);
});

// Insert after dropdown
versionDropdown.parentElement.insertBefore(duplicateBtn, versionDropdown.nextSibling);

function updateVersionControlsVisibility(presetOrType) {
  const versionDropdown = document.getElementById('versionSelect');
  const duplicateBtn = document.getElementById('duplicateVersionBtn');

  if (presetOrType === 'modbox' || presetOrType === 'v8') {
    versionDropdown.style.display = 'none';
    versionDropdown.disabled = true;
    duplicateBtn.style.display = 'none';
    versionLabel.style.display = 'none';
  } else if (presetOrType === 'v9') {
    versionDropdown.style.display = 'inline-block';
    versionLabel.style.display = 'block';

    // Only enable dropdown if versionsCache has at least one version
    if (Object.keys(versionsCache).length) {
      versionDropdown.disabled = false;
	  duplicateBtn.style.display = 'inline';
    } else {
      versionDropdown.disabled = true;
	  duplicateBtn.style.display = 'none';
    }
  }
}


</script>

</body>
</html>
